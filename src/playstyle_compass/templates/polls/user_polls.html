{% extends "base.html" %}
{% load i18n %}
{% load static %}
{% load custom_filters %}

{% block page_header %}
<div class="header">
    {% if is_own_polls %}
        <h3>{% trans "MY POLLS" %}</h3>
    {% else %}
        <h3>
            {% trans "POLLS CREATED BY" %} 
            <a href="{% url 'users:view_profile' user.userprofile.profile_name %}">
                {{ user.userprofile.profile_name }}
            </a>
        </h3>
    {% endif %}
</div>
{% endblock page_header %}

{% block description %}
{% if is_own_polls %}
    {% blocktrans %}Manage your polls. Delete polls you’ve created and track how others are engaging with them!{% endblocktrans %}
{% else %}
    {% blocktrans %}Discover polls created by this user. Share your opinions by voting and see how others have participated!{% endblocktrans %}
{% endif %}
{% endblock description %}


{% block content %}

<link rel="stylesheet" type="text/css" href="{% static 'css/playstyle_compass/polls.css' %}">

<div class="polls-container">
  {% if polls %}
    {% for poll in polls %}
      <div class="poll-card">
        <h2>{{ poll.title }}</h2>
        <p class="poll-description">{{ poll.description|default:_("No description available") }}</p>
        <p class="poll-meta">
          {% trans "Created on" %} {{ poll.created_at|date:"F j, Y, g:i a" }}
        </p>

        <form method="post" action="{% url 'playstyle_compass:vote' id=poll.id %}">
          {% csrf_token %}
          <div class="poll-options">
            {% for option in poll.options.all %}
              <div class="radio-option">
                <label>
                  <input type="radio" name="option" value="{{ option.id }}" {% if user_votes|get_item:poll.id == option.id %}checked{% endif %}>
                  {{ option.text }}
                </label>
              </div>
            {% endfor %}
          </div>

          {% if user_votes|get_item:poll.id %}
            <div class="poll-voted-message">
              <span class="icon">✔️</span>
              <p class="voted-message">{% trans "Your vote:" %} 
                {% for option in poll.options.all %}
                  {% if option.id == user_votes|get_item:poll.id %}
                    <span class="voted-option">{{ option.text }}</span>
                  {% endif %}
                {% endfor %}
              </p>
            </div>
          {% else %}
            <button type="submit" class="vote-button" {% if user_votes|get_item:poll.id %}disabled{% endif %}>{% trans "Vote" %}</button>
          {% endif %}
        </form>

        <button class="results-toggle-btn" onclick="toggleResults({{ poll.id }})">{% trans "View Results" %}</button>
         {% if is_own_polls %}
          <form method="post" action="{% url 'playstyle_compass:delete_poll' poll.id %}" onsubmit="return confirmDelete()">
            {% csrf_token %}
            <button type="submit" class="delete-poll-button">{% trans "Delete" %}</button>
          </form>

          {% endif %}

        <div id="results-{{ poll.id }}" class="poll-results" style="display: none;">
          <ul>
            {% for option in poll.options.all %}
              <li>{{ option.text }}: {{ option.votes.count }} {% trans "votes" %}</li>
            {% endfor %}
          </ul>
        </div>
      </div>
    {% endfor %}
  {% else %}
    <p>{% trans "No polls created by this user." %}</p>
  {% endif %}
</div>

<script src="{% static 'js/playstyle_compass/polls.js' %}"></script>

{% endblock content %}
